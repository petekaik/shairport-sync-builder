name: Ristiin-käännä Shairport-Sync (ARMv6)

on:
  push:
    branches:
      - main  # Tai 'master'

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    permissions:
      contents: read 

    steps:
      # Vaihe 1: Noudetaan lähdekoodi
      - name: Checkout Lähdekoodi
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Vaihe 2: Määritellään dynaaminen versionumero
      - name: Määritä versionumero
        id: version
        run: echo "PACKAGE_VERSION=$(git describe --tags --always --dirty)" >> $GITHUB_OUTPUT

      # Vaihe 3: Asennetaan QEMU ja Docker Buildx ristiin-kääntämistä varten
      - name: Asenna QEMU
        uses: docker/setup-qemu-action@v3

      - name: Asenna Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Vaihe 4: Rakennetaan Docker-image (ja samalla .deb-paketti)
      - name: Rakenna ja paketoi
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.builder
          platforms: linux/arm/v6
          build-args: |
            PACKAGE_VERSION=${{ steps.version.outputs.PACKAGE_VERSION }}
          tags: shairport-sync-builder:latest
          load: true

      # Vaihe 5: Puretaan .deb-paketti ulos kontista
      - name: Luo artifacts-kansio
        run: mkdir -p ./artifacts

      - name: Pura .deb-paketti builder-imagesta
        run: |
          docker run --rm --platform linux/arm/v6 \
            -v $(pwd)/artifacts:/artifacts_out \
            shairport-sync-builder:latest \
            cp /artifacts/*.deb /artifacts_out/

      # Vaihe 6: Näytetään tulos (hyvä debuggaukseen)
      - name: Näytä luodut paketit
        run: ls -l ./artifacts

      # Vaihe 7: Tallenna .deb-paketti GitHub-artifaktiksi
      - name: Tallenna Artifakti
        uses: actions/upload-artifact@v4
        with:
          name: shairport-sync-deb-armv6
          path: ./artifacts/*.deb

      # Vaihe 8: Julkaisu omaan APT-repositorioon
      - name: Julkaise APT-repositorioon
        if: false # Ei ajeta vielä
        run: |
          echo "Tässä kohtaa ajetaan scp ja ssh-komennot..."